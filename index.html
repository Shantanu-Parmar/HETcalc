<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solenoid Magnetic Field Optimizer</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: url('https://source.unsplash.com/random/1920x1080/?tech,abstract') no-repeat center center fixed;
            background-size: cover;
            color: #333;
        }
        h1 {
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .main-content {
            display: flex;
            gap: 10px;
        }
        .left-pane {
            flex: 1;
            min-width: 0;
        }
        .right-pane {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .restrictions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .restrictions label {
            flex: 1;
            min-width: 120px;
        }
        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
            min-width: 150px;
        }
        input[type="number"], select {
            padding: 6px;
            margin: 2px 0;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.9em;
            width: 80px;
            pointer-events: auto;
        }
        .slider-value {
            font-size: 0.8em;
            color: #555;
            margin-left: 10px;
        }
        #results {
            margin: 0;
            font-size: 0.9em;
            padding: 10px;
            border-radius: 6px;
        }
        #effectLog {
            margin: 0;
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            max-height: 150px;
            overflow-y: auto;
        }
        #effectLog table {
            width: 100%;
            border-collapse: collapse;
        }
        #effectLog th, #effectLog td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
            font-size: 0.9em;
        }
        #effectLog td button {
            padding: 2px 5px;
            font-size: 0.7em;
        }
        canvas {
            display: block;
            margin: 10px auto;
            max-width: 100%;
        }
        .controls {
            text-align: center;
            margin: 10px 0;
        }
        .equations {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .equations h3 {
            margin-top: 0;
        }
        .equations p {
            margin: 5px 0;
            font-family: monospace;
        }
        .green { color: green; }
        .red { color: red; }
        .nudge { font-style: italic; font-size: 0.8em; color: #e74c3c; }
        @media (max-width: 600px) {
            .main-content {
                flex-direction: column;
            }
            .left-pane, .right-pane {
                width: 100%;
            }
            .input-row {
                flex-direction: column;
                align-items: stretch;
            }
            input[type="number"], select {
                width: 100%;
            }
            .restrictions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>Solenoid Magnetic Field Optimizer</h1>
    <div class="calculator">
        <div class="main-content">
            <div class="left-pane">
                <div class="container" id="thresholds">
                    <h3>Thresholds</h3>
                    <div class="restrictions">
                        <label for="maxB">Max B (T):</label><input type="number" id="maxB" min="0" step="0.001" value="0.01">
                        <label for="maxLayers">Max Layers:</label><input type="number" id="maxLayers" min="1" value="10">
                        <label for="maxThickness">Max Thick (mm):</label><input type="number" id="maxThickness" min="0" step="0.1" value="10">
                        <label for="maxWireLength">Max Wire (m):</label><input type="number" id="maxWireLength" min="0" step="0.1" value="50">
                        <label for="maxPower">Max Power (W):</label><input type="number" id="maxPower" min="0" step="0.1" value="20">
                        <label for="maxResistance">Max Resistance (Ω):</label><input type="number" id="maxResistance" min="0" step="0.1" value="10">
                    </div>
                </div>
                <div class="container" id="inputParameters">
                    <h3>Input Parameters</h3>
                    <div class="input-row"><label for="solenoidLength">Solenoid Length (cm):</label><input type="number" id="solenoidLength" value="50" step="0.1" oninput="syncInputs()"><span class="slider-value" id="solenoidLengthValue">50 cm</span></div>
                    <div class="input-row"><label for="linearOffset">Solenoid Offset (on each side) (mm):</label><input type="number" id="linearOffset" min="0" step="0.1" value="5" oninput="syncInputs()"><span class="slider-value" id="linearOffsetValue">5 mm</span></div>
                    <div class="input-row"><label for="maxOuterRadius">Solenoid Outer Radius (cm):</label><input type="number" id="maxOuterRadius" value="10" step="0.1" oninput="syncInputs()"><span class="slider-value" id="maxOuterRadiusValue">10 cm</span></div>
                    <div class="input-row"><label for="innerRadius">Solenoid Inner Radius (cm):</label><input type="number" id="innerRadius" value="5" step="0.1" oninput="syncInputs()"><span class="slider-value" id="innerRadiusValue">5 cm</span></div>
                    <div class="input-row"><label for="wireDiameter">Diameter of Wire (cm):*</label><select id="wireDiameter" onchange="toggleWireInput()">
                        <option value="0.259">10 AWG (0.259 cm bare)</option>
                        <option value="0.230">11 AWG (0.230 cm bare)</option>
                        <option value="0.205">12 AWG (0.205 cm bare)</option>
                        <option value="0.183">13 AWG (0.183 cm bare)</option>
                        <option value="0.163">14 AWG (0.163 cm bare)</option>
                        <option value="0.145">15 AWG (0.145 cm bare)</option>
                        <option value="0.129">16 AWG (0.129 cm bare)</option>
                        <option value="0.115">17 AWG (0.115 cm bare)</option>
                        <option value="0.102">18 AWG (0.102 cm bare)</option>
                        <option value="0.091">19 AWG (0.091 cm bare)</option>
                        <option value="0.081">20 AWG (0.081 cm bare)</option>
                        <option value="0.072">21 AWG (0.072 cm bare)</option>
                        <option value="0.064">22 AWG (0.064 cm bare)</option>
                        <option value="0.057">23 AWG (0.057 cm bare)</option>
                        <option value="0.051">24 AWG (0.051 cm bare)</option>
                        <option value="0.045">25 AWG (0.045 cm bare)</option>
                        <option value="0.040">26 AWG (0.040 cm bare)</option>
                        <option value="0.036">27 AWG (0.036 cm bare)</option>
                        <option value="0.032">28 AWG (0.032 cm bare)</option>
                        <option value="0.029">29 AWG (0.029 cm bare)</option>
                        <option value="0.025">30 AWG (0.025 cm bare)</option>
                        <option value="0.0227">31 AWG (0.0227 cm bare)</option>
                        <option value="0.0202">32 AWG (0.0202 cm bare)</option>
                        <option value="0.0180">33 AWG (0.0180 cm bare)</option>
                        <option value="0.0160">34 AWG (0.0160 cm bare)</option>
                        <option value="0.0143">35 AWG (0.0143 cm bare)</option>
                        <option value="0.0127">36 AWG (0.0127 cm bare)</option>
                        <option value="0.0113">37 AWG (0.0113 cm bare)</option>
                        <option value="0.0101">38 AWG (0.0101 cm bare)</option>
                        <option value="0.0090">39 AWG (0.0090 cm bare)</option>
                        <option value="0.0080">40 AWG (0.0080 cm bare)</option>
                    </select><input type="number" id="wireDiameterManual" step="0.01" placeholder="Custom" oninput="toggleWireInput()" style="width: 80px; pointer-events: auto;"><input type="number" id="wireInsulationManual" step="0.001" placeholder="Insulation (cm)" value="0.025" oninput="toggleWireInput()" onclick="this.focus()" style="width: 80px; pointer-events: auto; z-index: 1;"><span class="slider-value" id="wireDiameterValue">0.259 cm bare, 0.025 cm insulation</span></div>
                    <div class="input-row"><label for="current">Current (A):</label><input type="number" id="current" value="2" step="0.1" oninput="syncInputs()"><span class="slider-value" id="currentValue">2 A</span></div>
                    <div class="input-row"><label for="resistivity">Resistivity (×10⁻⁶ Ω·cm):</label><select id="resistivity" onchange="toggleResistivity()">
                        <option value="1.68">Copper (1.68)</option>
                        <option value="2.82">Aluminum (2.82)</option>
                        <option value="1.59">Silver (1.59)</option>
                        <option value="2.44">Gold (2.44)</option>
                    </select><input type="number" id="resistivityManual" step="0.01" placeholder="Custom" oninput="toggleResistivity()" style="width: 80px;"><span class="slider-value" id="resistivityValue">1.68 ×10⁻⁶ Ω·cm</span></div>
                    <div class="input-row"><label for="linearMassDensity">Linear Mass Density (g/cm³):</label><select id="linearMassDensity" onchange="toggleLinearMassDensity()">
                        <option value="8.92">Copper (8.92)</option>
                        <option value="2.70">Aluminum (2.70)</option>
                        <option value="10.49">Silver (10.49)</option>
                        <option value="19.32">Gold (19.32)</option>
                    </select><input type="number" id="linearMassDensityManual" step="0.01" placeholder="Custom" oninput="toggleLinearMassDensity()" style="width: 80px;"><span class="slider-value" id="linearMassDensityValue">8.92 g/cm³</span></div>
                </div>
            </div>
            <div class="right-pane">
                <div class="container" id="results">
                    <h3>Results</h3>
                    <div id="results"></div>
                </div>
                <div class="container" id="logging">
                    <h3>Logging</h3>
                    <div class="controls">
                        <button onclick="recordValues()">Record Value</button>
                        <button onclick="downloadCSV()">Download CSV</button>
                    </div>
                    <div id="effectLog">
                        <table>
                            <thead>
                                <tr>
                                    <th>Wire</th>
                                    <th>Electrical</th>
                                    <th>Magnetic</th>
                                    <th>Mechanical</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="effectLogBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="container" id="animation">
                    <h3>Animation</h3>
                    <canvas id="solenoidViz" width="600" height="400" style="border:1px solid #000; background: white;"></canvas>
                </div>
            </div>
        </div>
        <div class="equations">
            <h3>Equations Used</h3>
            <p>ntp = (L_solenoid - (2 * L_soloff)) / D_wire</p>
            <p>n_layers = (2 / sqrt(3)) * ((R_max - R_min) / D_wire - 1) + 1</p>
            <p>n_T = ntp * n_layers</p>
            <p>lw = 2 * π * ntp * n_layers * (R_min + 0.5 * D_wire + (√3 / 4) * D_wire * (n_layers - 1))</p>
            <p>A_cross = π * (D_bare / 2)²</p>
            <p>V = A_cross * lw</p>
            <p>mw = ρ * V</p>
            <p>t_total = D_wire * (1 + (√3 / 2) * (n_layers - 1)) * 10</p>
            <p>n = n_T / L_solenoid</p>
            <p>B = μ₀ * n * I</p>
            <p>R = ρ * lw / A_cross</p>
            <p>P = I² * R</p>
            <p>Assumptions: Hexagonal packing of wires. The wire length formula uses an average radius approximation, assuming constant turns per layer (ntp). Density (ρ) is user-selected (g/cm³). Resistivity (ρ) is user-selected (×10⁻⁶ Ω·cm, converted to Ω·m). μ₀ = 4π × 10⁻⁷ H/m. All lengths are in meters, density in g/cm³, thickness in mm, magnetic field in tesla, resistance in ohms, and power in watts.</p>
            <p>* Wire diameters based on annealed copper at 20 °C from "Copper wire tables," United States National Bureau of Standards, 1914, https://nvlpubs.nist.gov/nistpubs/Legacy/hb/nbshandbook100.pdf</p>
        </div>
    </div>

    <script>
        let global_ntp = 0;
        let global_nlayers = 0;

        function updateDynamicRange(sliderId, value) {
            const minValue = Math.max(value * 0.5, value - 50);
            const maxValue = Math.min(value * 1.5, value + 50);
            document.getElementById(sliderId + 'Value').textContent = value + (sliderId === 'solenoidLength' ? ' cm' : sliderId === 'linearOffset' ? ' mm' : sliderId === 'maxOuterRadius' || sliderId === 'innerRadius' ? ' cm' : sliderId === 'current' ? ' A' : '');
        }

        function syncInputs() {
            const inputs = ['solenoidLength', 'linearOffset', 'maxOuterRadius', 'innerRadius', 'wireDiameter', 'current', 'resistivity', 'linearMassDensity'];
            inputs.forEach(id => {
                let value = document.getElementById(id).value;
                if (id === 'wireDiameter') {
                    const insulation = parseFloat(document.getElementById('wireInsulationManual').value) || 0.025;
                    value = document.getElementById('wireDiameter').value || document.getElementById('wireDiameterManual').value || '0.259';
                    document.getElementById('wireDiameterManual').value = value !== document.getElementById('wireDiameter').value ? value : '';
                    document.getElementById('wireDiameter').value = value === document.getElementById('wireDiameterManual').value ? '' : value;
                    document.getElementById('wireDiameterValue').textContent = value + ' cm bare, ' + insulation + ' cm insulation';
                } else if (id === 'resistivity') {
                    value = document.getElementById('resistivity').value || document.getElementById('resistivityManual').value || '1.68';
                    document.getElementById('resistivityManual').value = value !== document.getElementById('resistivity').value ? value : '';
                    document.getElementById('resistivity').value = value === document.getElementById('resistivityManual').value ? '' : value;
                    document.getElementById('resistivityValue').textContent = value + ' ×10⁻⁶ Ω·cm';
                } else if (id === 'linearMassDensity') {
                    value = document.getElementById('linearMassDensity').value || document.getElementById('linearMassDensityManual').value || '8.92';
                    document.getElementById('linearMassDensityManual').value = value !== document.getElementById('linearMassDensity').value ? value : '';
                    document.getElementById('linearMassDensity').value = value === document.getElementById('linearMassDensityManual').value ? '' : value;
                    document.getElementById('linearMassDensityValue').textContent = value + ' g/cm³';
                } else {
                    document.getElementById(id).value = value;
                    updateDynamicRange(id, parseFloat(value));
                }
            });
            calculate();
        }

        function toggleWireInput() {
            const dropdown = document.getElementById('wireDiameter');
            const manual = document.getElementById('wireDiameterManual');
            const insulation = document.getElementById('wireInsulationManual');
            const value = manual.value && manual.value !== '' ? manual.value : dropdown.value || '0.259';
            const insulValue = insulation.value || '0.025';
            if (manual.value && manual.value !== '') {
                dropdown.value = '';
            }
            document.getElementById('wireDiameterValue').textContent = value + ' cm bare, ' + insulValue + ' cm insulation';
            syncInputs();
        }

        function toggleResistivity() {
            const dropdown = document.getElementById('resistivity');
            const manual = document.getElementById('resistivityManual');
            if (manual.value && manual.value !== '') {
                dropdown.value = '';
                document.getElementById('resistivityValue').textContent = manual.value + ' ×10⁻⁶ Ω·cm';
            } else if (dropdown.value) {
                manual.value = '';
                document.getElementById('resistivityValue').textContent = dropdown.value + ' ×10⁻⁶ Ω·cm';
            }
            syncInputs();
        }

        function toggleLinearMassDensity() {
            const dropdown = document.getElementById('linearMassDensity');
            const manual = document.getElementById('linearMassDensityManual');
            if (manual.value && manual.value !== '' ) {
                dropdown.value = '';
                document.getElementById('linearMassDensityValue').textContent = manual.value + ' g/cm³';
            } else if (dropdown.value) {
                manual.value = '';
                document.getElementById('linearMassDensityValue').textContent = dropdown.value + ' g/cm³';
            }
            syncInputs();
        }

        function calculate() {
            const solenoidLength = parseFloat(document.getElementById('solenoidLength').value) / 100; // Convert cm to m
            const linearOffset = parseFloat(document.getElementById('linearOffset').value) / 1000; // Convert mm to m
            const maxOuterRadius = parseFloat(document.getElementById('maxOuterRadius').value) / 100; // Convert cm to m
            const innerRadius = parseFloat(document.getElementById('innerRadius').value) / 100; // Convert cm to m
            const bareDiameter = parseFloat(document.getElementById('wireDiameter').value || document.getElementById('wireDiameterManual').value || '0.259'); // cm
            const wireInsulation = parseFloat(document.getElementById('wireInsulationManual').value) || 0.025; // cm
            const effectiveDiameter = bareDiameter + wireInsulation; // cm
            const effectiveDiameterM = effectiveDiameter / 100; // m
            const bareDiameterM = bareDiameter / 100; // m
            const linearMassDensity = parseFloat(document.getElementById('linearMassDensity').value || document.getElementById('linearMassDensityManual').value || '8.92'); // g/cm³
            const resistivity = parseFloat(document.getElementById('resistivity').value || document.getElementById('resistivityManual').value || '1.68') * 1e-8; // Convert ×10⁻⁶ Ω·cm to Ω·m
            const current = parseFloat(document.getElementById('current').value) || 2; // A
            const maxLayersInput = parseFloat(document.getElementById('maxLayers').value) || Infinity;
            const maxThickness = parseFloat(document.getElementById('maxThickness').value) || Infinity;
            const maxWireLength = parseFloat(document.getElementById('maxWireLength').value) || Infinity;
            const maxB = parseFloat(document.getElementById('maxB').value) || Infinity;
            const maxPower = parseFloat(document.getElementById('maxPower').value) || Infinity;
            const maxResistance = parseFloat(document.getElementById('maxResistance').value) || Infinity;

            const ntp = Math.floor((solenoidLength - (2 * linearOffset)) / effectiveDiameterM);
            const nlayers = Math.floor(((2 / Math.sqrt(3)) * ((maxOuterRadius - innerRadius) / effectiveDiameterM - 1)) + 1);
            const nT = ntp * nlayers;

            const lw = 2 * Math.PI * ntp * nlayers * (innerRadius + 0.5 * effectiveDiameterM + (Math.sqrt(3) / 4) * effectiveDiameterM * (nlayers - 1)); // m
            const crossSectionArea = Math.PI * Math.pow((bareDiameterM / 2), 2); // m²
            const volume = crossSectionArea * lw; // m³
            const mw = linearMassDensity * volume * 1e6 / 1000; // kg (density g/cm³ * volume m³ * 10^6 cm³/m³ / 1000 = kg)

            const totalThickness = effectiveDiameter * (1 + ((Math.sqrt(3) / 2) * (nlayers - 1))) * 10; // mm

            const n = (ntp * nlayers) / solenoidLength; // turns per meter
            const mu0 = 4 * Math.PI * 1e-7; // H/m
            const B = mu0 * n * current; // T
            const R = resistivity * lw / crossSectionArea; // Ω 
            const P = current * current * R; // W

            const layersClass = nlayers > maxLayersInput ? 'red' : 'green';
            const thicknessClass = totalThickness > maxThickness ? 'red' : 'green';
            const wireLengthClass = lw > maxWireLength ? 'red' : 'green';
            const bClass = B > maxB ? 'red' : 'green';
            const resistanceClass = R > maxResistance ? 'red' : 'green';
            const powerClass = P > maxPower ? 'red' : 'green';

            const nudge = (nlayers > maxLayersInput || totalThickness > maxThickness || lw > maxWireLength || B > maxB || R > maxResistance || P > maxPower) ? 
                '<div class="nudge">Adjust inputs to meet restrictions.</div>' : '';

            document.getElementById('results').innerHTML = `
                <strong>Results:</strong><br>
                Number of Turns per Layer: ${ntp.toFixed(2)}<br>
                Number of Layers: <span class="${layersClass}">${nlayers.toFixed(0)}</span><br>
                Total Number of Turns: ${nT.toFixed(2)}<br>
                Wire Length: <span class="${wireLengthClass}">${lw.toFixed(2)}</span> m<br>
                Total Mass of Coil: ${mw.toFixed(2)} kg<br>
                Total Thickness: <span class="${thicknessClass}">${totalThickness.toFixed(2)}</span> mm<br>
                Magnetic Field: <span class="${bClass}">${B.toFixed(10)}</span> T<br>
                Resistance: <span class="${resistanceClass}">${R.toFixed(2)}</span> Ω<br>
                Power: <span class="${powerClass}">${P.toFixed(2)}</span> W
                ${nudge}
            `;

            global_ntp = ntp;
            global_nlayers = nlayers;

            drawAnimation();
        }

        function recordValues() {
            const solenoidLength = parseFloat(document.getElementById('solenoidLength').value);
            const linearOffset = parseFloat(document.getElementById('linearOffset').value) / 10;
            const maxOuterRadius = parseFloat(document.getElementById('maxOuterRadius').value);
            const innerRadius = parseFloat(document.getElementById('innerRadius').value);
            const wireDiameter = parseFloat(document.getElementById('wireDiameter').value || document.getElementById('wireDiameterManual').value || '0.259');
            const current = parseFloat(document.getElementById('current').value);
            const resistivity = parseFloat(document.getElementById('resistivity').value || document.getElementById('resistivityManual').value || '1.68') * 1e-6;
            const linearMassDensity = parseFloat(document.getElementById('linearMassDensity').value || document.getElementById('linearMassDensityManual').value || '8.92');

            const wireColumn = `Wire Diameter: ${wireDiameter.toFixed(4)} cm`;
            const electricalColumn = `Current: ${current.toFixed(2)} A, Resistivity: ${resistivity.toFixed(2)} ×10⁻⁶ Ω·cm`;
            const magneticColumn = `N/A`;
            const mechanicalColumn = `Solenoid Length: ${solenoidLength.toFixed(2)} cm, Offset: ${linearOffset.toFixed(2)} cm`;

            const row = `<tr>
                <td>${wireColumn}</td>
                <td>${electricalColumn}</td>
                <td>${magneticColumn}</td>
                <td>${mechanicalColumn}</td>
                <td><button onclick="this.parentElement.parentElement.remove()">Delete</button></td>
            </tr>`;
            document.getElementById('effectLogBody').insertAdjacentHTML('afterbegin', row);
        }

        function downloadCSV() {
            const rows = Array.from(document.querySelectorAll('#effectLogBody tr'));
            const csv = [
                ['Wire (Diameter cm)', 'Electrical (Current A, Resistivity ×10⁻⁶ Ω·cm)', 'Magnetic', 'Mechanical (Solenoid Length cm, Offset cm)'].join(','),
                ...rows.map(row => Array.from(row.cells).slice(0, -1).map(cell => `"${cell.textContent}"`).join(','))
            ].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'solenoid_data.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        window.onload = syncInputs;

        const canvas = document.getElementById('solenoidViz');
        const ctx = canvas.getContext('2d');

        function drawAnimation() {
            const L_solenoid_cm = parseFloat(document.getElementById('solenoidLength').value) || 50;
            const L_soloff_mm = parseFloat(document.getElementById('linearOffset').value) || 5;
            const R_max_cm = parseFloat(document.getElementById('maxOuterRadius').value) || 10;
            const R_min_cm = parseFloat(document.getElementById('innerRadius').value) || 5;
            const bare_cm = parseFloat(document.getElementById('wireDiameter').value || document.getElementById('wireDiameterManual').value || 0.259);
            const insul_cm = parseFloat(document.getElementById('wireInsulationManual').value) || 0.025;
            const D_wire_cm = bare_cm + insul_cm;

            const L_soloff_cm = L_soloff_mm / 10;

            const display_turns = global_ntp; // Use full number of turns
            const n_layers = global_nlayers;

            // Cap for scaling
            const L_for_scale = Math.min(L_solenoid_cm, 50);
            const thickness_for_scale = Math.min(R_max_cm - R_min_cm, 100);

            // Dynamic scale to fit canvas with caps
            const scale_x = (canvas.width - 100) / L_for_scale;
            const scale_y = (canvas.height - 100) / thickness_for_scale;
            const scale = Math.min(scale_x, scale_y, 20);

            const D_wire_px = D_wire_cm * scale;
            const radius_px = D_wire_px / 2;
            const layer_spacing_px = D_wire_px * (Math.sqrt(3) / 2);
            let L_px = L_solenoid_cm * scale;
            let thickness_px = (R_max_cm - R_min_cm) * scale;
            const off_px = L_soloff_cm * scale;

            const x_start = 50;
            let x_end = x_start + L_px;
            const y_bottom = canvas.height - 50;
            let y_top = y_bottom - thickness_px;

            // Clip if beyond canvas
            if (x_end > canvas.width - 50) {
                x_end = canvas.width - 50;
            }
            if (y_top < 50) {
                y_top = 50;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw blue horizontal lines
            ctx.strokeStyle = 'blue';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x_start, y_bottom);
            ctx.lineTo(x_end, y_bottom);
            ctx.moveTo(x_start, y_top);
            ctx.lineTo(x_end, y_top);
            ctx.stroke();

            // Labels
            ctx.fillStyle = 'black';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('Rmin', x_start - 5, y_bottom + 4);
            ctx.fillText('Rmax', x_start - 5, y_top + 4);

            // Lsolenoid label
            ctx.textAlign = 'center';
            ctx.fillText('Lsolenoid', (x_start + x_end) / 2, y_bottom + 20);

            // Coil thickness vertical line and label
            const vert_x = x_end + 20;
            ctx.beginPath();
            ctx.moveTo(vert_x, y_top);
            ctx.lineTo(vert_x, y_bottom);
            ctx.stroke();

            ctx.save();
            ctx.translate(vert_x + 10, (y_top + y_bottom) / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText('coil thickness', 0, 0);
            ctx.restore();

            // Striped pattern for copper texture
            let patternCanvas = document.createElement('canvas');
            patternCanvas.width = 10;
            patternCanvas.height = 10;
            let pctx = patternCanvas.getContext('2d');
            pctx.fillStyle = '#B87333';
            pctx.fillRect(0, 0, 10, 10);
            pctx.strokeStyle = '#8B4513';
            pctx.lineWidth = 1;
            for (let i = 0; i < 10; i += 3) {
                pctx.beginPath();
                pctx.moveTo(0, i);
                pctx.lineTo(10, i);
                pctx.stroke();
            }

            const pattern = ctx.createPattern(patternCanvas, 'repeat');

            // Draw circles in hexagonal packing
            for (let layer = 0; layer < n_layers; layer++) {
                const y = y_bottom - radius_px - layer * layer_spacing_px;
                if (y - radius_px < y_top) continue; // Clip if beyond top

                const shift = (layer % 2 === 1) ? radius_px : 0;

                for (let turn = 0; turn < display_turns; turn++) {
                    const x = x_start + off_px + radius_px + turn * D_wire_px + shift;
                    if (x + radius_px > x_end) continue;

                    ctx.beginPath();
                    ctx.arc(x, y, radius_px, 0, 2 * Math.PI);
                    ctx.fillStyle = pattern;
                    ctx.fill();
                    ctx.strokeStyle = '#A0522D';
                    ctx.lineWidth = 0.5;
                    ctx.stroke();
                }
            }
        }

        // Add event listeners to update animation on input changes
        document.getElementById('solenoidLength').addEventListener('input', syncInputs);
        document.getElementById('linearOffset').addEventListener('input', syncInputs);
        document.getElementById('maxOuterRadius').addEventListener('input', syncInputs);
        document.getElementById('innerRadius').addEventListener('input', syncInputs);
        document.getElementById('wireDiameter').addEventListener('change', syncInputs);
        document.getElementById('wireDiameterManual').addEventListener('input', syncInputs);
        document.getElementById('wireInsulationManual').addEventListener('input', syncInputs);

        // Initial draw
        syncInputs();
    </script>
</body>
</html>